<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Concierge</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,sans-serif;background:#f5f5f5;padding:20px}
    .container{max-width:900px;margin:0 auto}
    .card{background:white;padding:30px;border-radius:16px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    h1{font-size:36px;margin-bottom:8px}
    .subtitle{color:#666;font-size:18px}
    label{display:block;font-weight:600;margin-bottom:10px;color:#333;font-size:15px}
    input,select{width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px}
    input:focus,select:focus{outline:none;border-color:#000}
    .btn{width:100%;padding:18px;background:#000;color:white;border:none;border-radius:12px;font-size:18px;font-weight:700;cursor:pointer;margin-top:10px}
    .btn:hover{background:#333}
    .btn:disabled{background:#ccc;cursor:not-allowed}
    .restaurant{background:white;padding:28px;border-radius:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:all 0.2s}
    .restaurant:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,0.12)}
    .restaurant h3{margin:0 0 6px 0;font-size:24px}
    .cuisine{color:#999;font-size:15px;margin-bottom:16px}
    .badges{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0;align-items:center}
    .badge{padding:8px 14px;border-radius:20px;font-size:14px;font-weight:600;border:2px solid #e0e0e0;background:#fafafa}
    .badge.distance{background:#e0f2fe;border-color:#7dd3fc;color:#075985}
    .hidden{display:none}
    .back-btn{padding:12px 24px;border:2px solid #ddd;border-radius:10px;background:white;cursor:pointer;font-weight:600;margin-bottom:24px;font-size:16px}
    .toggle-group{display:flex;gap:12px;margin-top:10px}
    .toggle-btn{flex:1;padding:14px;border:2px solid #e0e0e0;border-radius:10px;background:white;cursor:pointer;font-size:15px;font-weight:600;color:#333}
    .toggle-btn.active{background:#000;color:white;border-color:#000}
    .toggle-btn:hover{border-color:#000;background:#f5f5f5}
    .toggle-btn:hover.active{background:#000}
    .sort-bar{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:16px;background:#f9fafb;border-radius:12px}
    .section-divider{padding:12px 16px;margin:24px 0 16px 0;background:#f3f4f6;border-radius:10px;font-size:14px;font-weight:600;color:#6b7280;border-left:4px solid #d1d5db}
    .chatbot-btn{position:fixed;bottom:30px;right:30px;width:60px;height:60px;border-radius:50%;background:#000;color:white;border:none;font-size:28px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000;transition:all 0.2s}
    .chatbot-btn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(0,0,0,0.4)}
    .pac-container{z-index:10000!important;font-family:system-ui,sans-serif}
    @media(max-width:768px){.toggle-group{flex-direction:column}}
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <h1>üçΩÔ∏è AI Concierge</h1>
      <p class="subtitle">Find restaurants you can actually get into</p>
    </div>

    <div id="search" class="card">
      <div style="margin-bottom:20px">
        <label>üìç Your Location</label>
        <div style="display:flex;gap:10px">
          <input type="text" id="addressInput" placeholder="Enter address" value="New York, NY" style="flex:1">
          <button onclick="useCurrentLocation()" style="padding:14px 20px;border:2px solid #e0e0e0;border-radius:10px;background:white;cursor:pointer;font-weight:600">üìç Use My Location</button>
        </div>
      </div>

      <div style="margin-bottom:20px">
        <label>üìÖ Date & Time</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <input type="date" id="dateInput" style="flex:1;min-width:140px">
          <div style="display:flex;gap:6px;align-items:center;flex:1;min-width:200px">
            <select id="startTime" style="flex:1">
              <option value="11:00">11:00 AM</option>
              <option value="11:30">11:30 AM</option>
              <option value="12:00">12:00 PM</option>
              <option value="12:30">12:30 PM</option>
              <option value="13:00">1:00 PM</option>
              <option value="13:30">1:30 PM</option>
              <option value="14:00">2:00 PM</option>
              <option value="14:30">2:30 PM</option>
              <option value="15:00">3:00 PM</option>
              <option value="15:30">3:30 PM</option>
              <option value="16:00">4:00 PM</option>
              <option value="16:30">4:30 PM</option>
              <option value="17:00">5:00 PM</option>
              <option value="17:30">5:30 PM</option>
              <option value="18:00" selected>6:00 PM</option>
              <option value="18:30">6:30 PM</option>
              <option value="19:00">7:00 PM</option>
              <option value="19:30">7:30 PM</option>
              <option value="20:00">8:00 PM</option>
              <option value="20:30">8:30 PM</option>
              <option value="21:00">9:00 PM</option>
              <option value="21:30">9:30 PM</option>
              <option value="22:00">10:00 PM</option>
            </select>
            <span style="font-weight:600;color:#666">to</span>
            <select id="endTime" style="flex:1">
              <option value="12:00">12:00 PM</option>
              <option value="12:30">12:30 PM</option>
              <option value="13:00">1:00 PM</option>
              <option value="13:30">1:30 PM</option>
              <option value="14:00">2:00 PM</option>
              <option value="14:30">2:30 PM</option>
              <option value="15:00">3:00 PM</option>
              <option value="15:30">3:30 PM</option>
              <option value="16:00">4:00 PM</option>
              <option value="16:30">4:30 PM</option>
              <option value="17:00">5:00 PM</option>
              <option value="17:30">5:30 PM</option>
              <option value="18:00">6:00 PM</option>
              <option value="18:30">6:30 PM</option>
              <option value="19:00">7:00 PM</option>
              <option value="19:30">7:30 PM</option>
              <option value="20:00">8:00 PM</option>
              <option value="20:30" selected>8:30 PM</option>
              <option value="21:00">9:00 PM</option>
              <option value="21:30">9:30 PM</option>
              <option value="22:00">10:00 PM</option>
              <option value="22:30">10:30 PM</option>
              <option value="23:00">11:00 PM</option>
              <option value="23:30">11:30 PM</option>
            </select>
          </div>
        </div>
      </div>

      <div style="margin-bottom:20px">
        <label>üë• Party Size</label>
        <input type="number" id="party" value="2" min="1" max="20">
      </div>

      <div style="margin-bottom:20px">
        <label>üöó Transportation</label>
        <div class="toggle-group">
          <button class="toggle-btn active" onclick="setTransport(event,'walk')">üö∂ Walk</button>
          <button class="toggle-btn" onclick="setTransport(event,'drive')">üöó Drive</button>
          <button class="toggle-btn" onclick="setTransport(event,'transit')">üöá Transit</button>
          <button class="toggle-btn" onclick="setTransport(event,'radius')">üìç Radius</button>
        </div>
      </div>

      <div id="walkDistance" style="margin-bottom:20px">
        <label>üö∂ Max Walk</label>
        <select id="walkTime">
          <option value="10">10 min</option>
          <option value="15">15 min</option>
          <option value="20" selected>20 min</option>
          <option value="30">30 min</option>
        </select>
      </div>

      <div id="driveDistance" style="margin-bottom:20px;display:none">
        <label>üöó Max Drive</label>
        <select id="driveTime">
          <option value="10">10 min</option>
          <option value="15" selected>15 min</option>
          <option value="20">20 min</option>
          <option value="30">30 min</option>
        </select>
      </div>

      <div id="transitDistance" style="margin-bottom:20px;display:none">
        <label>üöá Max Transit</label>
        <select id="transitTime">
          <option value="15">15 min</option>
          <option value="20" selected>20 min</option>
          <option value="30">30 min</option>
          <option value="45">45 min</option>
        </select>
      </div>

      <div id="radiusDistance" style="margin-bottom:20px;display:none">
        <label>üìç Radius</label>
        <select id="radiusMiles">
          <option value="1">1 mile</option>
          <option value="2">2 miles</option>
          <option value="3" selected>3 miles</option>
          <option value="5">5 miles</option>
        </select>
      </div>

      <div style="margin-bottom:20px">
        <label>‚≠ê Quality</label>
        <select id="quality">
          <option value="any" selected>Any Quality</option>
          <option value="michelin">Michelin Stars</option>
          <option value="bib_gourmand">Bib Gourmand</option>
          <option value="recommended_44">Recommended (4.4+)</option>
          <option value="elite_45">Elite (4.5+)</option>
          <option value="strict_elite_47">Strict Elite (4.7+)</option>
        </select>
      </div>

      <div style="margin-bottom:20px">
        <label>üçï Cuisine</label>
        <select id="cuisine">
          <option value="any">Any</option>
          <option value="american">American</option>
          <option value="barbecue">Barbecue</option>
          <option value="chinese">Chinese</option>
          <option value="french">French</option>
          <option value="greek">Greek</option>
          <option value="indian">Indian</option>
          <option value="italian">Italian</option>
          <option value="japanese">Japanese</option>
          <option value="korean">Korean</option>
          <option value="mediterranean">Mediterranean</option>
          <option value="mexican">Mexican</option>
          <option value="seafood">Seafood</option>
          <option value="spanish">Spanish</option>
          <option value="steakhouse">Steakhouse</option>
          <option value="sushi">Sushi</option>
          <option value="thai">Thai</option>
          <option value="vietnamese">Vietnamese</option>
        </select>
      </div>

      <div style="margin-bottom:20px">
        <label>üéÅ Book with Rewards</label>
        <select id="rewards" onchange="setRewards(this.value)">
          <option value="any">Any</option>
          <option value="chase">üí≥ Chase Sapphire Reserve</option>
          <option value="rakuten">üõçÔ∏è Rakuten</option>
        </select>
      </div>

      <button class="btn" onclick="search()">üîç Find Restaurants</button>
    </div>

    <div id="results" class="hidden">
      <button class="back-btn" onclick="back()">‚Üê Back</button>
      <div id="warnings"></div>

      <div class="sort-bar">
        <label style="margin:0;font-weight:600">üìä Sort:</label>
        <select id="sortBy" onchange="sortResults()">
          <option value="distance">Distance</option>
          <option value="rating">Rating</option>
          <option value="price">Price</option>
        </select>
      </div>

      <div id="list"></div>
    </div>

    <button class="chatbot-btn" onclick="alert('Chat coming soon!')">üí¨</button>
  </div>

<script>
let state = { transport: 'walk', qualityFilter: 'any', showExpanded: false, rewardsFilter: 'any' };
let allRestaurants = [];
let isSearching = false;
let searchAbortController = null;

function setRewards(mode) {
  state.rewardsFilter = mode;
  if (allRestaurants.length > 0) sortResults();
}

// Chase Sapphire Reserve Exclusive Tables ‚Äî all restaurant names
const CHASE_SAPPHIRE_NAMES = [
  'phoenix palace','gjelina','altro paradiso',"sunn's",'parcelle chinatown',
  'estela',"l'abeille",'potluck club',"scarr's pizza",'kabawa',
  'san sabino','manhatta','don angie','fairfax','una pizza napoletana',
  'tolo','demo','muku',"jeffrey's grocery",'sappeisan',
  'joseph leonard','hawksmoor nyc','parcelle greenwich village','mitsuru',
  'sailor','casa mono','momofuku noodle bar','bar kabawa',
  'moody tongue sushi','the golden swan','red hook tavern','le b.',
  'blu on the hudson','momofuku noodle bar - uptown','strange delight',
  'brass','chez fifi','bar miller','aska',
  'di an di','the tavern at gramercy tavern','union square cafe',
  'the dining room at gramercy tavern','ci siamo','odo',
  'the bar room at the modern','sushi noz','noz market','the modern',
  'pig and khao - uws','maddy rose','felina steak',
  'drift restaurant & bar','meximodo','razza',
  'gramercy tavern','hawksmoor','pig and khao'
];

function isChaseRestaurant(name) {
  if (!name) return false;
  const n = name.toLowerCase().trim();
  for (const cn of CHASE_SAPPHIRE_NAMES) {
    if (n === cn || n.includes(cn) || cn.includes(n)) return true;
  }
  return false;
}

const DEPOSIT_RESTAURANTS = new Set([
  'eleven madison park','masa','per se',
  "chef's table at brooklyn fare",'sushi sho',
  'atomix','aska','atera','sushi noz','noz 17',
  'ko','blue hill at stone barns','shion 69 leonard street',
  'odo','saga','carbone','torrisi','yoshino','noda',
  'icca','frevo','kosaka','joji','cesar','tsukimi',
  'shota omakase','sushi by scratch restaurants',
  'sushi on me','sushi amane','torien'
]);
function isDepositRestaurant(name) {
  if (!name) return false;
  const n = name.toLowerCase().trim();
  if (DEPOSIT_RESTAURANTS.has(n)) return true;
  const noThe = n.replace(/^the\s+/, '');
  if (DEPOSIT_RESTAURANTS.has(noThe)) return true;
  return false;
}

const BUZZ_LINKS = {"Le Bernardin":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/le-bernardin"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/le-bernardin"},{"source":"GrubStreet","label":"Grub Street","url":"https://www.grubstreet.com/listings/le-bernardin.html"}]},"Eleven Madison Park":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/eleven-madison-park"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/eleven-madison-park"},{"source":"GrubStreet","label":"Grub Street","url":"https://www.grubstreet.com/listings/eleven-madison-park.html"}]},"Masa":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/masa-20"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/masa"}]},"Per Se":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/per-se"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/per-se"}]},"Chef's Table at Brooklyn Fare":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/chefs-table-at-brooklyn-fare"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/chefs-table-at-brooklyn-fare"}]},"Atomix":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/atomix"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/atomix"}]},"Jungsik":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/jungsik"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/jungsik"}]},"Aquavit":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/aquavit"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/aquavit"}]},"Casa Mono":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/casa-mono"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/casa-mono"}]},"Daniel":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/daniel"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/daniel"}]},"Gramercy Tavern":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/gramercy-tavern"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/gramercy-tavern"}]},"Jean-Georges":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/jean-georges"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/jean-georges-nyc"}]},"Kochi":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/kochi"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/kochi"}]},"Kosaka":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/kosaka"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/kosaka"}]},"Le Pavillon":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/le-pavillon"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/le-pavillon"}]},"Sushi Noz":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/sushi-noz"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/sushi-noz"}]},"Tatiana":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/tatiana-by-kwame-onwuachi"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/tatiana"}]},"Don Angie":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/don-angie"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/don-angie"}]},"Semma":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/semma"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/semma"}]},"Cote":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/cote-3"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/cote"}]},"Estela":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/estela"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/estela"}]},"Lilia":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/lilia"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/lilia"}]},"Crown Shy":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/crown-shy"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/crown-shy"}]},"Le Coucou":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/le-coucou"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/le-coucou"}]},"Oxomoco":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/oxomoco"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/oxomoco"}]},"The Four Horsemen":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/the-four-horsemen"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/the-four-horsemen"}]},"Rezdora":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/rezdora"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/rezdora"}]},"Francie":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/francie"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/francie"}]},"Casa Enrique":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/casa-enrique"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/casa-enrique"}]},"One White Street":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/one-white-street"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/one-white-street"}]},"Dhamaka":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/dhamaka"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/dhamaka"}]},"Gage & Tollner":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/gage-tollner"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/gage-and-tollner"}]},"Thai Diner":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/thai-diner"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/thai-diner"}]},"Llama Inn":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/llama-inn"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/llama-inn"}]},"Via Carota":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/via-carota"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/via-carota"}]},"Carbone":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/carbone"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/carbone"}]},"Balthazar":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/balthazar"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/balthazar"}]},"Claro":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/claro"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/claro"}]},"Red Hook Tavern":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/red-hook-tavern"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/red-hook-tavern"}]},"L'Industrie Pizzeria":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/lindustrie-pizzeria"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/lindustrie-pizzeria"}]},"Ugly Baby":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/ugly-baby"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/ugly-baby"}]},"Sushi Nakazawa":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/sushi-nakazawa"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/sushi-nakazawa"}]},"Odo":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/odo"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/odo"}]},"The Musket Room":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/the-musket-room"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/the-musket-room"}]},"Contra":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/contra"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/contra"}]},"Oxalis":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/oxalis"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/oxalis"}]},"Caviar Russe":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/caviar-russe"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/caviar-russe"}]},"Gabriel Kreuther":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/gabriel-kreuther"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/gabriel-kreuther"}]},"L'Abeille":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/labeille"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/labeille"}]},"The Modern":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/the-modern"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/the-modern"}]},"15 East":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/15-east"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/15-east"}]},"Loring Place":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/loring-place"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/loring-place"}]},"Ci Siamo":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/ci-siamo"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/ci-siamo"}]},"I Sodi":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/i-sodi"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/i-sodi"}]},"L'Artusi":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/lartusi"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/lartusi"}]},"Momofuku Ko":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/momofuku-ko"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/momofuku-ko"}]},"Oiji Mi":{"tier":"michelin","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/oiji-mi"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/oiji-mi"}]},"Sal Tang's":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/sal-tangs"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/sal-tangs"}]},"La Dong":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/la-dong"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/la-dong"}]},"Phayul":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/phayul"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/phayul"}]},"Cardamom":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/cardamom"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/cardamom"}]},"Ruffian":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/ruffian"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/ruffian"}]},"Bohemian Spirit":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/bohemian-spirit"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/bohemian-spirit"}]},"B√°nh Anh Em":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/banh-anh-em"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/banh-anh-em"}]},"Ishq":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/ishq"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/ishq"}]},"Yellow Rose":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/yellow-rose"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/yellow-rose"}]},"SaRanRom Thai":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/saranrom-thai"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/saranrom-thai"}]},"Gordo's Cantina":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/gordos-cantina"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/gordos-cantina"}]},"Hupo":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/hupo"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/hupo"}]},"Rolo's":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/rolos"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/rolos"}]},"Hometown Bar B Que New York":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/hometown-bar-b-que"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/hometown-bar-b-que"}]},"Bayon":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/bayon"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/bayon"}]},"CheLi":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/cheli"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/cheli"}]},"Cho Dang Gol":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/cho-dang-gol"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/cho-dang-gol"}]},"Laliko":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/laliko"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/laliko"}]},"Pierozek":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/pierozek"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/pierozek"}]},"Caleta 111 Cevicheria":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/caleta-111-cevicheria"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/caleta-111-cevicheria"}]},"Tong Sam Gyup Goo Yi":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/tong-sam-gyup-goo-yi"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/tong-sam-gyup-goo-yi"}]},"Legend of Taste":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/legend-of-taste"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/legend-of-taste"}]},"Miss Ada":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/miss-ada"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/miss-ada"}]},"Oso":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/oso"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/oso"}]},"Chavela's":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/chavelas"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/chavelas"}]},"Speedy Romeo":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/speedy-romeo"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/speedy-romeo"}]},"Katz's":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/katzs-delicatessen"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/katzs-delicatessen"}]},"Untable":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/untable"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/untable"}]},"Little Alley":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/little-alley"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/little-alley"}]},"Pinch Chinese":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/pinch-chinese"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/pinch-chinese"}]},"Caf√© Mars":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/cafe-mars"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/cafe-mars"}]},"Tha Phraya":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/tha-phraya"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/tha-phraya"}]},"Nami Nori":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/nami-nori"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/nami-nori"}]},"Sagara":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/sagara"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/sagara"}]},"Shalom Japan":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/shalom-japan"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/shalom-japan"}]},"HanGawi":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/hangawi"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/hangawi"}]},"Tolo":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/tolo"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/tolo"}]},"Little Myanmar":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/little-myanmar"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/little-myanmar"}]},"Kung Fu Little Steamed Buns Ramen":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/kung-fu-little-steamed-buns-ramen"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/kung-fu-little-steamed-buns-ramen"}]},"Tonchin":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/tonchin"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/tonchin"}]},"Russ & Daughters Cafe":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/russ-and-daughters-cafe"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/russ-and-daughters-cafe"}]},"Una Pizza Napoletana":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/una-pizza-napoletana"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/una-pizza-napoletana"}]},"Dim Sum Go Go":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/dim-sum-go-go"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/dim-sum-go-go"}]},"Pranakhon":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/pranakhon"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/pranakhon"}]},"Agi's Counter":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/agis-counter"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/agis-counter"}]},"Jiang Nan":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/jiang-nan"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/jiang-nan"}]},"8282":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/8282"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/8282"}]},"Alley 41":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/alley-41"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/alley-41"}]},"Alta Calidad":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/alta-calidad"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/alta-calidad"}]},"Atla":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/atla"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/atla"}]},"Bonnie's":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/bonnies"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/bonnies"}]},"Boro6 Wine Bar":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/boro6-wine-bar"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/boro6-wine-bar"}]},"Bungalow":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/bungalow"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/bungalow"}]},"Burrata":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/burrata"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/burrata"}]},"C as in Charlie":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/c-as-in-charlie"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/c-as-in-charlie"}]},"Cervo's":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/cervos"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/cervos"}]},"Chalong":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/chalong"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/chalong"}]},"Chuan Tian Xia":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/chuan-tian-xia"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/chuan-tian-xia"}]},"Chutney Masala":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/chutney-masala"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/chutney-masala"}]},"Coqodaq":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/coqodaq"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/coqodaq"}]},"Covacha":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/covacha"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/covacha"}]},"Enoteca Maria":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/enoteca-maria"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/enoteca-maria"}]},"Falansai":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/falansai"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/falansai"}]},"Haenyeo":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/haenyeo"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/haenyeo"}]},"LORE":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/lore"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/lore"}]},"Lungi":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/lungi"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/lungi"}]},"M√°L√† Project":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/mala-project"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/mala-project"}]},"Momofuku Noodle Bar":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/momofuku-noodle-bar"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/momofuku-noodle-bar"}]},"Noreetuh":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/noreetuh"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/noreetuh"}]},"Olmo":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/olmo"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/olmo"}]},"Peppercorn Station":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/peppercorn-station"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/peppercorn-station"}]},"Potluck Club":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/potluck-club"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/potluck-club"}]},"Roberta's":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/robertas"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/robertas"}]},"Runner Up":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/runner-up"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/runner-up"}]},"Yemenat":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/yemenat"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/yemenat"}]},"Win Son":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/win-son"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/win-son"}]},"Zaab Zaab":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/zaab-zaab"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/zaab-zaab"}]},"Cecily":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/cecily"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/cecily"}]},"Soba Totto":{"tier":"bib","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/soba-totto"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/soba-totto"}]},"Phoenix Palace":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/phoenix-palace"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/phoenix-palace"}]},"Gjelina":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/gjelina"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/gjelina"}]},"Altro Paradiso":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/altro-paradiso"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/altro-paradiso"}]},"Sunn's":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/sunns"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/sunns"}]},"Parcelle Chinatown":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/parcelle-chinatown"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/parcelle-chinatown"}]},"Scarr's Pizza":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/scarrs-pizza"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/scarrs-pizza"}]},"Kabawa":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/kabawa"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/kabawa"}]},"San Sabino":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/san-sabino"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/san-sabino"}]},"Manhatta":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/manhatta"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/manhatta"}]},"Fairfax":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/fairfax"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/fairfax"}]},"Demo":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/demo"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/demo"}]},"Muku":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/muku"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/muku"}]},"Jeffrey's Grocery":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/jeffreys-grocery"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/jeffreys-grocery"}]},"Sappeisan":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/sappeisan"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/sappeisan"}]},"Joseph Leonard":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/joseph-leonard"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/joseph-leonard"}]},"Hawksmoor NYC":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/hawksmoor-nyc"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/hawksmoor-nyc"}]},"Parcelle Greenwich Village":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/parcelle-greenwich-village"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/parcelle-greenwich-village"}]},"Mitsuru":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/mitsuru"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/mitsuru"}]},"Sailor":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/sailor"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/sailor"}]},"Bar Kabawa":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/bar-kabawa"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/bar-kabawa"}]},"Moody Tongue Sushi":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/moody-tongue-sushi"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/moody-tongue-sushi"}]},"The Golden Swan":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/the-golden-swan"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/the-golden-swan"}]},"Le B.":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/le-b"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/le-b"}]},"Blu on the Hudson":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/blu-on-the-hudson"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/blu-on-the-hudson"}]},"Strange Delight":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/strange-delight"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/strange-delight"}]},"Brass":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/brass"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/brass"}]},"Chez Fifi":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/chez-fifi"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/chez-fifi"}]},"Bar Miller":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/bar-miller"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/bar-miller"}]},"Aska":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/aska"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/aska"}]},"Di An Di":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/di-an-di"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/di-an-di"}]},"The Tavern at Gramercy Tavern":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/the-tavern-at-gramercy-tavern"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/the-tavern-at-gramercy-tavern"}]},"Union Square Cafe":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/union-square-cafe"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/union-square-cafe"}]},"The Dining Room at Gramercy Tavern":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/the-dining-room-at-gramercy-tavern"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/the-dining-room-at-gramercy-tavern"}]},"The Bar Room at the Modern":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/the-bar-room-at-the-modern"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/the-bar-room-at-the-modern"}]},"Noz Market":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/noz-market"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/noz-market"}]},"Pig and Khao":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/pig-and-khao"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/pig-and-khao"}]},"Maddy Rose":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/maddy-rose"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/maddy-rose"}]},"Felina Steak":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/felina-steak"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/felina-steak"}]},"Drift Restaurant & Bar":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/drift-restaurant-and-bar"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/drift-restaurant-and-bar"}]},"Meximodo":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/meximodo"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/meximodo"}]},"Razza":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/razza"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/razza"}]},"Hawksmoor":{"tier":"chase","links":[{"source":"Eater","label":"Eater","url":"https://ny.eater.com/venue/hawksmoor"},{"source":"Infatuation","label":"Infatuation","url":"https://www.theinfatuation.com/new-york/reviews/hawksmoor"}]}};

function getBuzzLinks(name) {
  if (!name) return null;
  const n = name.trim();
  if (BUZZ_LINKS[n]) return BUZZ_LINKS[n];
  const nLow = n.toLowerCase();
  for (const [key, val] of Object.entries(BUZZ_LINKS)) {
    if (key.toLowerCase() === nLow) return val;
    if (nLow.includes(key.toLowerCase()) || key.toLowerCase().includes(nLow)) return val;
  }
  return null;
}

function michelinRank(r) {
  if (!r.michelin) return 0;
  const d = r.michelin.distinction || '';
  const s = r.michelin.stars || 0;
  if (s >= 1) return 100 + s;
  if (d === 'bib_gourmand' || d === 'bib') return 50;
  if (d === 'recommended') return 25;
  return 10;
}

function hasPrice(r) {
  return r.price_level != null && r.price_level !== undefined && r.price_level > 0;
}

function useCurrentLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      position => {
        document.getElementById('addressInput').value = `${position.coords.latitude},${position.coords.longitude}`;
      },
      () => alert('Could not get location')
    );
  }
}

function setTransport(evt, mode) {
  state.transport = mode;
  const parentDiv = evt.target.parentElement;
  parentDiv.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
  evt.target.classList.add('active');

  document.getElementById('walkDistance').style.display = mode === 'walk' ? 'block' : 'none';
  document.getElementById('driveDistance').style.display = mode === 'drive' ? 'block' : 'none';
  document.getElementById('transitDistance').style.display = mode === 'transit' ? 'block' : 'none';
  document.getElementById('radiusDistance').style.display = mode === 'radius' ? 'block' : 'none';
}

function filterByQuality(restaurants) {
  const q = state.qualityFilter;
  let filtered = restaurants;

  if (q === 'any') { /* keep all */ }
  else if (q === 'michelin' || q === 'bib_gourmand') { /* already filtered by search */ }
  else {
    filtered = filtered.filter(r => {
      if (r.michelin) return true;
      const rating = Number(r.googleRating || 0);
      if (q === 'strict_elite_47') return rating >= 4.7;
      if (q === 'elite_45') return rating >= 4.5;
      if (q === 'recommended_44') return rating >= 4.4;
      return true;
    });
  }

  return filtered;
}

async function search() {
  if (isSearching) return;

  if (searchAbortController) searchAbortController.abort();
  isSearching = true;
  searchAbortController = new AbortController();

  const searchBtn = document.querySelector('.btn');
  searchBtn.disabled = true;
  searchBtn.style.opacity = '0.5';
  searchBtn.textContent = 'üîç Searching...';

  const location = document.getElementById('addressInput').value;
  const cuisine = document.getElementById('cuisine').value;
  state.qualityFilter = document.getElementById('quality').value;

  const openNow = false;

  let maxWalkMinutes = null, maxDriveMinutes = null, maxTransitMinutes = null;
  if (state.transport === 'walk') maxWalkMinutes = parseInt(document.getElementById('walkTime').value, 10);
  else if (state.transport === 'drive') maxDriveMinutes = parseInt(document.getElementById('driveTime').value, 10);
  else if (state.transport === 'transit') maxTransitMinutes = parseInt(document.getElementById('transitTime').value, 10);

  document.getElementById('search').classList.add('hidden');
  document.getElementById('results').classList.remove('hidden');

  document.getElementById('warnings').innerHTML = '';
  document.getElementById('list').innerHTML =
    '<div style="text-align:center;padding:40px">üîç Finding candidates...</div>';

  try {
    // Chase Sapphire Reserve mode ‚Äî ALWAYS takes priority when selected
    if (state.rewardsFilter === 'chase') {
      document.getElementById('sortBy').value = 'distance';
      document.getElementById('list').innerHTML =
        '<div style="text-align:center;padding:40px">üí≥ Loading Chase Sapphire Reserve restaurants (15 mile radius)...</div>';

      const resp = await fetch('/.netlify/functions/search-candidates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ location, quality: 'chase_sapphire' }),
        signal: searchAbortController.signal
      });

      const data = await resp.json();

      if (data?.error) {
        document.getElementById('warnings').innerHTML = `
          <div style="background:#fee2e2;border:2px solid #fca5a5;padding:12px;border-radius:8px;margin-bottom:16px;color:#991b1b;font-weight:800">
            ‚ùå ${data.error}
          </div>
        `;
        document.getElementById('list').innerHTML =
          `<div style="text-align:center;padding:40px">No results (see error above)</div>`;
        return;
      }

      allRestaurants = Array.isArray(data.elite) ? data.elite.map(r => ({
        ...r,
        walkMinutes: r.walkMinEstimate,
        driveMinutes: r.driveMinEstimate,
        transitMinutes: r.transitMinEstimate
      })) : [];

      document.getElementById('warnings').innerHTML = `
        <div style="background:#e0f2fe;border:2px solid #7dd3fc;padding:12px;border-radius:8px;margin-bottom:16px;color:#075985">
          üìç ${data.confirmedAddress || location}
        </div>
        <div id="resultCountBadge" style="background:#d1fae5;border:2px solid #6ee7b7;padding:12px;border-radius:8px;margin-bottom:16px;color:#065f46;font-weight:800">
          ‚úì Showing <span id="resultCount">0</span> Chase Sapphire Reserve restaurants within 15 miles
        </div>
      `;

      sortResults();
      return;
    }

    // Rakuten mode ‚Äî dedicated 15 mile radius search
    if (state.rewardsFilter === 'rakuten') {
      document.getElementById('sortBy').value = 'distance';
      document.getElementById('list').innerHTML =
        '<div style="text-align:center;padding:40px">üõçÔ∏è Loading Rakuten restaurants (15 mile radius)...</div>';

      const resp = await fetch('/.netlify/functions/search-candidates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ location, quality: 'rakuten' }),
        signal: searchAbortController.signal
      });

      const data = await resp.json();

      if (data?.error) {
        document.getElementById('warnings').innerHTML = `
          <div style="background:#fee2e2;border:2px solid #fca5a5;padding:12px;border-radius:8px;margin-bottom:16px;color:#991b1b;font-weight:800">
            ‚ùå ${data.error}
          </div>
        `;
        document.getElementById('list').innerHTML =
          `<div style="text-align:center;padding:40px">No results (see error above)</div>`;
        return;
      }

      allRestaurants = Array.isArray(data.elite) ? data.elite.map(r => ({
        ...r,
        walkMinutes: r.walkMinEstimate,
        driveMinutes: r.driveMinEstimate,
        transitMinutes: r.transitMinEstimate
      })) : [];

      document.getElementById('warnings').innerHTML = `
        <div style="background:#e0f2fe;border:2px solid #7dd3fc;padding:12px;border-radius:8px;margin-bottom:16px;color:#075985">
          üìç ${data.confirmedAddress || location}
        </div>
        <div id="resultCountBadge" style="background:#d1fae5;border:2px solid #6ee7b7;padding:12px;border-radius:8px;margin-bottom:16px;color:#065f46;font-weight:800">
          ‚úì Showing <span id="resultCount">0</span> Rakuten restaurants within 15 miles
        </div>
      `;

      sortResults();
      return;
    }

    if (state.qualityFilter === 'michelin') {
      document.getElementById('sortBy').value = 'distance';
      document.getElementById('list').innerHTML =
        '<div style="text-align:center;padding:40px">üèÖ Loading Michelin (15 mile radius)...</div>';

      const resp = await fetch('/.netlify/functions/search-michelin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ location, radiusMiles: 15 }),
        signal: searchAbortController.signal
      });

      if (!resp.ok) {
        const txt = await resp.text();
        throw new Error(`search-michelin failed: ${resp.status} ${txt}`);
      }

      const data = await resp.json();

      if (data?.error) {
        document.getElementById('warnings').innerHTML = `
          <div style="background:#fee2e2;border:2px solid #fca5a5;padding:12px;border-radius:8px;margin-bottom:16px;color:#991b1b;font-weight:800">
            ‚ùå ${data.error}
          </div>
        `;
        document.getElementById('list').innerHTML =
          `<div style="text-align:center;padding:40px">No results (see error above)</div>`;
        return;
      }

      allRestaurants = Array.isArray(data.michelin) ? data.michelin.map(r => {
        const d = r.distanceMiles ?? null;
        const walk = r.walkMinEstimate ?? r.walkMinutes ?? (d != null ? Math.round(d * 20) : null);
        const drive = r.driveMinEstimate ?? r.driveMinutes ?? (d != null ? Math.round(d * 4) : null);
        const transit = r.transitMinEstimate ?? r.transitMinutes ?? (d != null ? Math.round(d * 6) : null);
        return {
          ...r,
          walkMinutes: walk,
          driveMinutes: drive,
          transitMinutes: transit,
          booking_platform: r.booking_platform || null,
          booking_url: r.booking_url || null
        };
      }) : [];

      document.getElementById('warnings').innerHTML = `
        <div style="background:#e0f2fe;border:2px solid #7dd3fc;padding:12px;border-radius:8px;margin-bottom:16px;color:#075985">
          üìç ${data.confirmedAddress || location}
        </div>
        <div id="resultCountBadge" style="background:#d1fae5;border:2px solid #6ee7b7;padding:12px;border-radius:8px;margin-bottom:16px;color:#065f46;font-weight:800">
          ‚úì Showing <span id="resultCount">0</span> Michelin restaurants within 15 miles (sorted by distance)
        </div>
      `;

      sortResults();
      return;
    }

    if (state.qualityFilter === 'bib_gourmand') {
      document.getElementById('sortBy').value = 'distance';
      document.getElementById('list').innerHTML =
        '<div style="text-align:center;padding:40px">üçΩÔ∏è Loading Bib Gourmand (15 mile radius)...</div>';

      const resp = await fetch('/.netlify/functions/search-candidates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ location, quality: 'bib_gourmand' }),
        signal: searchAbortController.signal
      });

      const data = await resp.json();

      if (data?.error) {
        document.getElementById('warnings').innerHTML = `
          <div style="background:#fee2e2;border:2px solid #fca5a5;padding:12px;border-radius:8px;margin-bottom:16px;color:#991b1b;font-weight:800">
            ‚ùå ${data.error}
          </div>
        `;
        document.getElementById('list').innerHTML =
          `<div style="text-align:center;padding:40px">No results (see error above)</div>`;
        return;
      }

      allRestaurants = Array.isArray(data.elite) ? data.elite.map(r => ({
        ...r,
        walkMinutes: r.walkMinEstimate,
        driveMinutes: r.driveMinEstimate,
        transitMinutes: r.transitMinEstimate
      })) : [];

      document.getElementById('warnings').innerHTML = `
        <div style="background:#e0f2fe;border:2px solid #7dd3fc;padding:12px;border-radius:8px;margin-bottom:16px;color:#075985">
          üìç ${data.confirmedAddress || location}
        </div>
        <div id="resultCountBadge" style="background:#d1fae5;border:2px solid #6ee7b7;padding:12px;border-radius:8px;margin-bottom:16px;color:#065f46;font-weight:800">
          ‚úì Showing <span id="resultCount">0</span> Bib Gourmand restaurants within 15 miles (sorted by distance)
        </div>
      `;

      sortResults();
      return;
    }

    const step1Response = await fetch('/.netlify/functions/search-candidates', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        location,
        cuisine: cuisine === 'any' ? undefined : cuisine,
        openNow,
        quality: state.qualityFilter
      }),
      signal: searchAbortController.signal
    });

    const step1Data = await step1Response.json();

    if (step1Data?.error) {
      document.getElementById('warnings').innerHTML = `
        <div style="background:#fee2e2;border:2px solid #fca5a5;padding:12px;border-radius:8px;margin-bottom:16px;color:#991b1b;font-weight:800">
          ‚ùå ${step1Data.error}
        </div>
      `;
      document.getElementById('list').innerHTML =
        `<div style="text-align:center;padding:40px">No results (see error above)</div>`;
      return;
    }

    const eliteRestaurants = Array.isArray(step1Data.elite) ? step1Data.elite : [];
    const moreOptionsRestaurants = Array.isArray(step1Data.moreOptions) ? step1Data.moreOptions : [];

    allRestaurants = [...eliteRestaurants, ...moreOptionsRestaurants].map(c => ({
      ...c,
      walkMinutes: c.walkMinutes ?? c.walkMinEstimate ?? null,
      driveMinutes: c.driveMinutes ?? c.driveMinEstimate ?? null,
      transitMinutes: c.transitMinutes ?? c.transitMinEstimate ?? null
    }));

    document.getElementById('warnings').innerHTML = `
      <div style="background:#e0f2fe;border:2px solid #7dd3fc;padding:12px;border-radius:8px;margin-bottom:16px;color:#075985">
        üìç ${step1Data.confirmedAddress || location}
      </div>
      <div style="background:#fef3c7;border:2px solid #fcd34d;padding:12px;border-radius:8px;margin-bottom:16px;color:#92400e;font-weight:700">
        ‚è±Ô∏è Found ${allRestaurants.length} candidates. Getting precise times...
      </div>
      <div id="resultCountBadge" style="background:#d1fae5;border:2px solid #6ee7b7;padding:12px;border-radius:8px;margin-bottom:16px;color:#065f46;font-weight:800">
        ‚úì Showing <span id="resultCount">0</span> restaurants
      </div>
    `;

    sortResults();

    let enrichLimit = 200;
    if (state.transport === 'walk') {
      if (maxWalkMinutes >= 30) enrichLimit = 250;
      else if (maxWalkMinutes >= 20) enrichLimit = 200;
      else enrichLimit = 150;
    } else if (state.transport === 'drive') {
      enrichLimit = 200;
    } else if (state.transport === 'transit') {
      enrichLimit = 200;
    }

    const originalCandidates = [...allRestaurants];

    const toEnrich = [...originalCandidates]
      .sort((a, b) => {
        const da = (a.distanceMiles ?? 999999);
        const db = (b.distanceMiles ?? 999999);
        if (da !== db) return da - db;

        const wa = (a.walkMinEstimate ?? 999999);
        const wb = (b.walkMinEstimate ?? 999999);
        if (wa !== wb) return wa - wb;

        return String(a.name || '').localeCompare(String(b.name || ''));
      })
      .slice(0, enrichLimit);

    const step2Response = await fetch('/.netlify/functions/enrich-times', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        candidates: toEnrich,
        userLocation: step1Data.userLocation,
        transportMode: state.transport,
        targetMinResults: 20,
        cuisineFilter: cuisine === 'any' ? null : cuisine,
        walkTimeLimit: maxWalkMinutes
      }),
      signal: searchAbortController.signal
    });

    if (!step2Response.ok) {
      const errTxt = await step2Response.text();
      throw new Error(`enrich-times failed: ${step2Response.status} ${errTxt}`);
    }

    const step2Data = await step2Response.json();
    const enriched = Array.isArray(step2Data.enrichedCandidates) ? step2Data.enrichedCandidates : [];
    const enrichedById = new Map(enriched.map(r => [r.place_id, r]));

    allRestaurants = originalCandidates.map(r => {
      const e = enrichedById.get(r.place_id);
      if (!e) return r;

      return {
        ...r,
        ...e,
        walkMinutes: e.walkMinutes ?? e.walkMinEstimate ?? r.walkMinutes ?? r.walkMinEstimate ?? null,
        driveMinutes: e.driveMinutes ?? e.driveMinEstimate ?? r.driveMinutes ?? r.driveMinEstimate ?? null,
        transitMinutes: e.transitMinutes ?? e.transitMinEstimate ?? r.transitMinutes ?? r.transitMinEstimate ?? null
      };
    });

    let realTimeFiltered = allRestaurants;
    if (state.rewardsFilter === 'any') {
      if (state.transport === 'walk' && maxWalkMinutes) realTimeFiltered = realTimeFiltered.filter(r => r.walkMinutes != null && r.walkMinutes <= maxWalkMinutes);
      else if (state.transport === 'drive' && maxDriveMinutes) realTimeFiltered = realTimeFiltered.filter(r => r.driveMinutes != null && r.driveMinutes <= maxDriveMinutes);
      else if (state.transport === 'transit' && maxTransitMinutes) realTimeFiltered = realTimeFiltered.filter(r => r.transitMinutes != null && r.transitMinutes <= maxTransitMinutes);
    }
    allRestaurants = realTimeFiltered;

    document.getElementById('warnings').innerHTML = `
      <div style="background:#e0f2fe;border:2px solid #7dd3fc;padding:12px;border-radius:8px;margin-bottom:16px;color:#075985">
        üìç ${step1Data.confirmedAddress || location}
      </div>
      <div id="resultCountBadge" style="background:#d1fae5;border:2px solid #6ee7b7;padding:12px;border-radius:8px;margin-bottom:16px;color:#065f46;font-weight:800">
        ‚úì Showing <span id="resultCount">0</span> restaurants
      </div>
    `;

    sortResults();

  } catch (error) {
    console.error('Search error:', error);
    if (error.name === 'AbortError') return;

    const errorMsg = error.message ? `üòî ${error.message}` : 'üòî Search failed';

    document.getElementById('warnings').innerHTML = `
      <div style="background:#fee2e2;border:2px solid #fca5a5;padding:12px;border-radius:8px;margin-bottom:16px;color:#991b1b;font-weight:800">
        ${errorMsg}
      </div>
    `;
    document.getElementById('list').innerHTML = `<div style="text-align:center;padding:40px">${errorMsg}</div>`;
  } finally {
    isSearching = false;
    const searchBtn = document.querySelector('.btn');
    searchBtn.disabled = false;
    searchBtn.style.opacity = '1';
    searchBtn.textContent = 'üîç Find Restaurants';
  }
}

function sortResults() {
  let filtered = filterByQuality(allRestaurants);

  const sortBy = document.getElementById('sortBy').value;

  if (sortBy === 'price') {
    const priced = filtered.filter(r => hasPrice(r));
    const noPrice = filtered.filter(r => !hasPrice(r));

    priced.sort((a, b) => {
      if (a.price_level !== b.price_level) return a.price_level - b.price_level;
      const ma = michelinRank(a), mb = michelinRank(b);
      if (ma !== mb) return mb - ma;
      return (b.googleRating || 0) - (a.googleRating || 0);
    });

    noPrice.sort((a, b) => {
      const ma = michelinRank(a), mb = michelinRank(b);
      if (ma !== mb) return mb - ma;
      return (b.googleRating || 0) - (a.googleRating || 0);
    });

    displayResults(priced, noPrice);
  } else {
    let sorted = [...filtered];

    if (sortBy === 'rating') {
      sorted.sort((a, b) => {
        const ma = michelinRank(a), mb = michelinRank(b);
        if (ma !== mb) return mb - ma;
        return (b.googleRating || 0) - (a.googleRating || 0);
      });
    } else if (sortBy === 'distance') {
      sorted.sort((a, b) => {
        const da = a.distanceMiles ?? 999999;
        const db = b.distanceMiles ?? 999999;
        if (da !== db) return da - db;
        const ma = michelinRank(a), mb = michelinRank(b);
        if (ma !== mb) return mb - ma;
        if ((b.googleRating || 0) !== (a.googleRating || 0)) return (b.googleRating || 0) - (a.googleRating || 0);
        return String(a.name || '').localeCompare(String(b.name || ''));
      });
    }

    displayResults(sorted, null);
  }
}

function renderBuzz(r) {
  const buzz = getBuzzLinks(r.name);
  if (!buzz || !buzz.links || buzz.links.length === 0) return '';
  const isMichelin = buzz.tier === 'michelin';
  const isBib = buzz.tier === 'bib';
  const isChase = buzz.tier === 'chase';
  const accent = isMichelin ? '#dc2626' : isBib ? '#ea580c' : isChase ? '#1a3c6e' : '#6b7280';
  const bg = isMichelin ? '#fef2f2' : isBib ? '#fff7ed' : isChase ? '#eff6ff' : '#f9fafb';
  const border = isMichelin ? '#fca5a5' : isBib ? '#fdba74' : isChase ? '#93c5fd' : '#d1d5db';
  const id = 'buzz_' + (r.place_id || r.name || '').replace(/[^a-zA-Z0-9]/g, '_');
  const chips = buzz.links.slice(0, 3).map(l => {
    const icon = l.source === 'Eater' ? 'üç¥' : l.source === 'Infatuation' ? '‚ù§Ô∏è' : 'üì∞';
    return `<a href="${l.url}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:14px;font-size:12px;font-weight:600;text-decoration:none;color:${accent};background:${bg};border:1px solid ${border}">${icon} ${l.label}</a>`;
  }).join('');
  return `
    <div style="margin-top:4px">
      <button onclick="var el=document.getElementById('${id}');el.style.display=el.style.display==='none'?'flex':'none';this.querySelector('.bc').textContent=el.style.display==='none'?'‚ñ∏':'‚ñæ'"
        style="padding:4px 10px;border-radius:14px;font-size:12px;font-weight:700;border:1px solid ${border};background:${bg};color:${accent};cursor:pointer;display:inline-flex;align-items:center;gap:4px">
        üî• Buzz (${buzz.links.length}) <span class="bc">‚ñ∏</span>
      </button>
      <div id="${id}" style="display:none;flex-wrap:wrap;gap:6px;margin-top:6px">${chips}</div>
    </div>`;
}

function renderCard(r) {
  let distanceHtml = '';
  if (r.walkMinutes != null) distanceHtml += `<span class="badge distance">üö∂ ${r.walkMinutes} min</span>`;
  if (r.driveMinutes != null) distanceHtml += `<span class="badge distance">üöó ${r.driveMinutes} min</span>`;
  if (r.transitMinutes != null) distanceHtml += `<span class="badge distance">üöá ${r.transitMinutes} min</span>`;
  if (r.distanceMiles != null) distanceHtml += `<span class="badge distance">üìç ${r.distanceMiles} mi</span>`;

  let michelinHtml = '';
  if (r.michelin) {
    const stars = r.michelin.stars || 0;
    const distinction = r.michelin.distinction || '';
    if (stars === 3) michelinHtml = `<span class="badge" style="background:#ff4444;color:white;border-color:#ff4444">‚≠ê‚≠ê‚≠ê Michelin Three Stars</span>`;
    else if (stars === 2) michelinHtml = `<span class="badge" style="background:#ff4444;color:white;border-color:#ff4444">‚≠ê‚≠ê Michelin Two Stars</span>`;
    else if (stars === 1) michelinHtml = `<span class="badge" style="background:#ff4444;color:white;border-color:#ff4444">‚≠ê Michelin One Star</span>`;
    else if (distinction === 'bib_gourmand' || distinction === 'bib') michelinHtml = `<span class="badge" style="background:#e65100;color:white;border-color:#e65100">üçΩÔ∏è Bib Gourmand</span>`;
    else if (distinction === 'recommended') michelinHtml = `<span class="badge" style="background:#9c27b0;color:white;border-color:#9c27b0">‚ú® Michelin Recommended</span>`;
    else michelinHtml = `<span class="badge" style="background:#ff4444;color:white;border-color:#ff4444">Michelin Selected</span>`;
  }

  const rating = (r.googleRating || 0);
  const reviews = (r.googleReviewCount || 0);

  const reviewsUrl = r.place_id
    ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.name || '')}&query_place_id=${r.place_id}`
    : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((r.name || '') + ' restaurant New York, NY')}`;

  const ratingHtml = r.michelin
    ? ''
    : (r.googleRating != null && r.googleRating !== 0)
      ? `<a href="${reviewsUrl}" target="_blank" rel="noopener" style="padding:8px 14px;border-radius:20px;font-size:14px;font-weight:600;border:2px solid #e0e0e0;background:#fafafa;text-decoration:none;color:inherit;cursor:pointer;display:inline-flex;align-items:center">‚≠ê ${Number(rating).toFixed(1)} (${reviews})</a>`
      : `<span class="badge" style="color:#666">‚≠ê Google rating N/A</span>`;

  const priceHtml = hasPrice(r) ? `<span class="badge">üí∞ ${'$'.repeat(r.price_level)}</span>` : '';

  const chaseHtml = (state.rewardsFilter === 'chase' && isChaseRestaurant(r.name)) ? `<span class="badge" style="background:#1a3c6e;color:white;border-color:#1a3c6e;font-size:12px">üí≥ Chase Sapphire Reserve</span>` : '';
  const rakutenHtml = (state.rewardsFilter === 'rakuten') ? `<a href="https://www.rakuten.com/dining" target="_blank" rel="noopener" class="badge" style="background:#bf0000;color:white;border-color:#bf0000;font-size:12px;text-decoration:none;cursor:pointer">üõçÔ∏è Rakuten</a>` : '';

  // Deposit warning - prominent standalone line
  let depositHtml = '';
  const needsDeposit = r.deposit_type === 'deposit' || r.deposit_type === 'prepay' || r.deposit_type === 'cc_hold' || isDepositRestaurant(r.name);
  if (needsDeposit) {
    depositHtml = `<div style="margin:6px 0;padding:6px 10px;background:#fef2f2;border:1px solid #fca5a5;border-radius:8px;color:#991b1b;font-size:13px;font-weight:600">‚ö†Ô∏è Requires Deposit or Prepay</div>`;
  }

  const mapsUrl = r.place_id
    ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.name || '')}&query_place_id=${r.place_id}`
    : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((r.name || '') + ' ' + (r.formatted_address || r.vicinity || r.address || 'New York, NY'))}`;

  const reserveUrl = r.place_id
    ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.name || '')}&query_place_id=${r.place_id}`
    : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((r.name || '') + ' restaurant New York, NY')}`;

  let bookingHtml = '';
  if (r.booking_url && r.booking_platform) {
    let cleanUrl = r.booking_url;
    // Strip Google redirect wrappers
    if (cleanUrl.includes('google.com/url')) {
      try {
        const u = new URL(cleanUrl);
        cleanUrl = u.searchParams.get('q') || u.searchParams.get('url') || cleanUrl;
      } catch(e) {}
    }
    // Strip trailing slashes (can cause 404s on some booking platforms)
    cleanUrl = cleanUrl.replace(/\/+$/, '');

    if (r.booking_platform === 'walkin') {
      bookingHtml = `<a href="${cleanUrl}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;margin:6px 0 4px 0;text-decoration:none;color:#2e7d32;font-size:13px;font-weight:600">üö∂ Walk-ins Welcome</a>`;
    } else if (r.booking_platform === 'opentable') {
      bookingHtml = `<a href="${cleanUrl}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;margin:6px 0 4px 0;padding:6px 12px;background:#da3743;color:white;border-radius:6px;text-decoration:none;font-size:13px;font-weight:600">üîñ Book on OpenTable</a>`;
    } else if (r.booking_platform === 'resy') {
      bookingHtml = `<a href="${cleanUrl}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;margin:6px 0 4px 0;padding:6px 12px;background:#c2185b;color:white;border-radius:6px;text-decoration:none;font-size:13px;font-weight:600">üîñ Book on Resy</a>`;
    } else if (r.booking_platform === 'tock') {
      bookingHtml = `<a href="${cleanUrl}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;margin:6px 0 4px 0;padding:6px 12px;background:#1a73e8;color:white;border-radius:6px;text-decoration:none;font-size:13px;font-weight:600">üîñ Book on Tock</a>`;
    } else {
      bookingHtml = `<a href="${cleanUrl}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;margin:6px 0 4px 0;text-decoration:none;color:#555;font-size:13px;font-weight:600">üîñ Book through Website</a>`;
    }
  } else {
    bookingHtml = `<a href="${reserveUrl}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;margin:6px 0 4px 0;text-decoration:none;color:#1a73e8;font-size:13px;font-weight:600">üîñ Reserve on Google</a>`;
  }

  return `
    <div class="restaurant">
      <h3>${r.name || 'Unknown'}</h3>
      <div class="cuisine">${r.cuisine ? r.cuisine + ' ¬∑ ' : ''}${r.vicinity || r.formatted_address || ''}</div>
      ${bookingHtml}
      ${depositHtml}
      <div class="badges">
        ${michelinHtml}
        ${ratingHtml}
        ${priceHtml}
        ${chaseHtml}
        ${rakutenHtml}
        ${r.opening_hours?.open_now ? '<span class="badge">‚úÖ Open</span>' : ''}
        ${distanceHtml}
        <button onclick="window.open('${mapsUrl}','_blank')"
          style="margin-left:auto;padding:8px 16px;background:#4285f4;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:14px">
          üìç Maps
        </button>
      </div>
      ${renderBuzz(r)}
    </div>
  `;
}

function displayResults(restaurants, noPriceRestaurants) {
  const totalCount = restaurants.length + (noPriceRestaurants ? noPriceRestaurants.length : 0);
  const countEl = document.getElementById('resultCount');
  if (countEl) countEl.textContent = String(totalCount);

  if (!totalCount) {
    document.getElementById('list').innerHTML =
      '<div style="text-align:center;padding:40px">No restaurants found</div>';
    return;
  }

  let html = restaurants.map(r => renderCard(r)).join('');

  if (noPriceRestaurants && noPriceRestaurants.length > 0) {
    html += `<div class="section-divider">üí∞ Price not available (${noPriceRestaurants.length})</div>`;
    html += noPriceRestaurants.map(r => renderCard(r)).join('');
  }

  document.getElementById('list').innerHTML = html;
}

function back() {
  document.getElementById('search').classList.remove('hidden');
  document.getElementById('results').classList.add('hidden');
}

async function initAutocomplete() {
  try {
    const resp = await fetch('/.netlify/functions/get-maps-key');
    const data = await resp.json();
    if (!data.key) return;

    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${data.key}&libraries=places&callback=setupAutocomplete`;
    script.async = true;
    document.head.appendChild(script);
  } catch (err) {
    console.log('Autocomplete init failed:', err);
  }
}

function setupAutocomplete() {
  const input = document.getElementById('addressInput');
  const autocomplete = new google.maps.places.Autocomplete(input, {
    types: ['address'],
    componentRestrictions: { country: 'us' }
  });

  autocomplete.addListener('place_changed', () => {
    const place = autocomplete.getPlace();
    if (place && place.formatted_address) {
      input.value = place.formatted_address;
    }
  });
}

initAutocomplete();

// Set default date to today
(function() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  document.getElementById('dateInput').value = `${yyyy}-${mm}-${dd}`;
  document.getElementById('dateInput').min = `${yyyy}-${mm}-${dd}`;
})();
</script>
</body>
</html>
