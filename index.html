<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Concierge</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,sans-serif;background:#f5f5f5;padding:20px}
    .container{max-width:900px;margin:0 auto}
    .card{background:white;padding:30px;border-radius:16px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    h1{font-size:36px;margin-bottom:8px}
    .subtitle{color:#666;font-size:18px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    label{display:block;font-weight:600;margin-bottom:10px;color:#333;font-size:15px}
    input,select{width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px}
    input:focus,select:focus{outline:none;border-color:#000}
    .btn{width:100%;padding:18px;background:#000;color:white;border:none;border-radius:12px;font-size:18px;font-weight:700;cursor:pointer;margin-top:10px}
    .btn:hover{background:#333}
    .btn:disabled{background:#ccc;cursor:not-allowed}
    .restaurant{background:white;padding:28px;border-radius:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:all 0.2s}
    .restaurant:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,0.12)}
    .restaurant h3{margin:0 0 6px 0;font-size:24px}
    .cuisine{color:#999;font-size:15px;margin-bottom:16px}
    .badges{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0;align-items:center}
    .badge{padding:8px 14px;border-radius:20px;font-size:14px;font-weight:600;border:2px solid #e0e0e0;background:#fafafa}
    .badge.distance{background:#e0f2fe;border-color:#7dd3fc;color:#075985}
    .hidden{display:none}
    .back-btn{padding:12px 24px;border:2px solid #ddd;border-radius:10px;background:white;cursor:pointer;font-weight:600;margin-bottom:24px;font-size:16px}
    .toggle-group{display:flex;gap:12px;margin-top:10px}
    .toggle-btn{flex:1;padding:14px;border:2px solid #e0e0e0;border-radius:10px;background:white;cursor:pointer;font-size:15px;font-weight:600;color:#333}
    .toggle-btn.active{background:#000;color:white;border-color:#000}
    .toggle-btn:hover{border-color:#000;background:#f5f5f5}
    .toggle-btn:hover.active{background:#000}
    .sort-bar{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:16px;background:#f9fafb;border-radius:12px}
    .chatbot-btn{position:fixed;bottom:30px;right:30px;width:60px;height:60px;border-radius:50%;background:#000;color:white;border:none;font-size:28px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000;transition:all 0.2s}
    .chatbot-btn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(0,0,0,0.4)}
    @media(max-width:768px){.form-row{grid-template-columns:1fr}.toggle-group{flex-direction:column}}
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <h1>ğŸ½ï¸ AI Concierge</h1>
      <p class="subtitle">Find restaurants you can actually get into</p>
    </div>

    <div id="search" class="card">
      <div style="margin-bottom:20px">
        <label>ğŸ“ Your Location</label>
        <div style="display:flex;gap:10px">
          <input type="text" id="addressInput" placeholder="Enter address" value="New York, NY" style="flex:1">
          <button onclick="useCurrentLocation()" style="padding:14px 20px;border:2px solid #e0e0e0;border-radius:10px;background:white;cursor:pointer;font-weight:600">ğŸ“ Use My Location</button>
        </div>
      </div>

      <div style="margin-bottom:20px">
        <label>ğŸ• Time</label>
        <select id="timewindow">
          <option value="breakfast">Breakfast</option>
          <option value="lunch">Lunch</option>
          <option value="prime" selected>Dinner</option>
        </select>
      </div>

      <div class="form-row">
        <div>
          <label>ğŸ‘¥ Party Size</label>
          <input type="number" id="party" value="2" min="1" max="20">
        </div>
        <div>
          <label>ğŸ’° Budget</label>
          <select id="budget">
            <option value="0-999">Any</option>
            <option value="1-50">$</option>
            <option value="50-100" selected>$$</option>
            <option value="100-150">$$$</option>
            <option value="150-500">$$$$</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom:20px">
        <label>ğŸš— Transportation</label>
        <div class="toggle-group">
          <button class="toggle-btn active" onclick="setTransport(event,'walk')">ğŸš¶ Walk</button>
          <button class="toggle-btn" onclick="setTransport(event,'drive')">ğŸš— Drive</button>
          <button class="toggle-btn" onclick="setTransport(event,'transit')">ğŸš‡ Transit</button>
          <button class="toggle-btn" onclick="setTransport(event,'radius')">ğŸ“ Radius</button>
        </div>
      </div>

      <div id="walkDistance" style="margin-bottom:20px">
        <label>ğŸš¶ Max Walk</label>
        <select id="walkTime">
          <option value="10">10 min</option>
          <option value="15">15 min</option>
          <option value="20" selected>20 min</option>
          <option value="30">30 min</option>
        </select>
      </div>

      <div id="driveDistance" style="margin-bottom:20px;display:none">
        <label>ğŸš— Max Drive</label>
        <select id="driveTime">
          <option value="10">10 min</option>
          <option value="15" selected>15 min</option>
          <option value="20">20 min</option>
          <option value="30">30 min</option>
        </select>
      </div>

      <div id="transitDistance" style="margin-bottom:20px;display:none">
        <label>ğŸš‡ Max Transit</label>
        <select id="transitTime">
          <option value="15">15 min</option>
          <option value="20" selected>20 min</option>
          <option value="30">30 min</option>
          <option value="45">45 min</option>
        </select>
      </div>

      <div id="radiusDistance" style="margin-bottom:20px;display:none">
        <label>ğŸ“ Radius</label>
        <select id="radiusMiles">
          <option value="1">1 mile</option>
          <option value="2">2 miles</option>
          <option value="3" selected>3 miles</option>
          <option value="5">5 miles</option>
        </select>
      </div>

      <div style="margin-bottom:20px">
        <label>â­ Quality</label>
        <select id="quality">
          <option value="any" selected>Any Quality</option>
          <option value="michelin">Michelin (15 mile radius)</option>
          <option value="five_star">5-Star (4.5+)</option>
          <option value="top_rated_and_above">Top Rated & Above (4.4+)</option>
          <option value="top_rated">Top Rated (4.4-4.49)</option>
        </select>
      </div>

      <div style="margin-bottom:20px">
        <label>ğŸ• Cuisine</label>
        <select id="cuisine">
          <option value="any">Any</option>
          <option value="italian">Italian</option>
          <option value="japanese">Japanese</option>
          <option value="korean">Korean</option>
          <option value="french">French</option>
          <option value="american">American</option>
        </select>
      </div>

      <button class="btn" onclick="search()">ğŸ” Find Restaurants</button>
    </div>

    <div id="results" class="hidden">
      <button class="back-btn" onclick="back()">â† Back</button>
      <div id="warnings"></div>

      <div class="sort-bar">
        <label style="margin:0;font-weight:600">ğŸ“Š Sort:</label>
        <select id="sortBy" onchange="sortResults()">
          <option value="distance">Distance</option>
          <option value="rating">Rating</option>
          <option value="price">Price</option>
        </select>
      </div>

      <div id="list"></div>
    </div>

    <button class="chatbot-btn" onclick="alert('Chat coming soon!')">ğŸ’¬</button>
  </div>

<script>
let state = { transport: 'walk', qualityFilter: 'any', showExpanded: false };
let allRestaurants = [];
let isSearching = false;
let searchAbortController = null;

function useCurrentLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      position => {
        document.getElementById('addressInput').value = `${position.coords.latitude},${position.coords.longitude}`;
      },
      () => alert('Could not get location')
    );
  }
}

function setTransport(evt, mode) {
  state.transport = mode;
  const parentDiv = evt.target.parentElement;
  parentDiv.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
  evt.target.classList.add('active');

  document.getElementById('walkDistance').style.display = mode === 'walk' ? 'block' : 'none';
  document.getElementById('driveDistance').style.display = mode === 'drive' ? 'block' : 'none';
  document.getElementById('transitDistance').style.display = mode === 'transit' ? 'block' : 'none';
  document.getElementById('radiusDistance').style.display = mode === 'radius' ? 'block' : 'none';
}

function filterByQuality(restaurants) {
  const q = state.qualityFilter;
  if (q === 'any') return restaurants;
  if (q === 'michelin') return restaurants;

  return restaurants.filter(r => {
    const rating = Number(r.googleRating || 0);

    // Match backend tiers so you don't collapse to 1-5 results
    if (q === 'five_star') return rating >= 4.5;
    if (q === 'top_rated_and_above') return rating >= 4.4;
    if (q === 'top_rated') return rating >= 4.4 && rating < 4.5;

    return true;
  });
}

async function search() {
  if (isSearching) return;

  if (searchAbortController) searchAbortController.abort();
  isSearching = true;
  searchAbortController = new AbortController();

  const searchBtn = document.querySelector('.btn');
  searchBtn.disabled = true;
  searchBtn.style.opacity = '0.5';
  searchBtn.textContent = 'ğŸ” Searching...';

  const location = document.getElementById('addressInput').value;
  const cuisine = document.getElementById('cuisine').value;
  const timeSlot = document.getElementById('timewindow').value;
  state.qualityFilter = document.getElementById('quality').value;

  // IMPORTANT: do NOT force "open now" based on time slot
  const openNow = false;

  let maxWalkMinutes = null, maxDriveMinutes = null, maxTransitMinutes = null;
  if (state.transport === 'walk') maxWalkMinutes = parseInt(document.getElementById('walkTime').value, 10);
  else if (state.transport === 'drive') maxDriveMinutes = parseInt(document.getElementById('driveTime').value, 10);
  else if (state.transport === 'transit') maxTransitMinutes = parseInt(document.getElementById('transitTime').value, 10);

  document.getElementById('search').classList.add('hidden');
  document.getElementById('results').classList.remove('hidden');

  document.getElementById('warnings').innerHTML = '';
  document.getElementById('list').innerHTML =
    '<div style="text-align:center;padding:40px">ğŸ” Finding candidates...</div>';

  try {
    // MICHELIN MODE
    if (state.qualityFilter === 'michelin') {
      document.getElementById('sortBy').value = 'distance';
      document.getElementById('list').innerHTML =
        '<div style="text-align:center;padding:40px">ğŸ… Loading Michelin (15 mile radius)...</div>';

      const resp = await fetch('/.netlify/functions/search-michelin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ location, radiusMiles: 15 }),
        signal: searchAbortController.signal
      });

      if (!resp.ok) {
        const txt = await resp.text();
        throw new Error(`search-michelin failed: ${resp.status} ${txt}`);
      }

      const data = await resp.json();

      if (data?.error) {
        document.getElementById('warnings').innerHTML = `
          <div style="background:#fee2e2;border:2px solid #fca5a5;padding:12px;border-radius:8px;margin-bottom:16px;color:#991b1b;font-weight:800">
            âŒ ${data.error}
          </div>
        `;
        document.getElementById('list').innerHTML =
          `<div style="text-align:center;padding:40px">No results (see error above)</div>`;
        return;
      }

      allRestaurants = Array.isArray(data.michelin) ? data.michelin.map(r => ({
        ...r,
        walkMinutes: r.walkMinEstimate,
        driveMinutes: r.driveMinEstimate,
        transitMinutes: r.transitMinEstimate
      })) : [];

      document.getElementById('warnings').innerHTML = `
        <div style="background:#e0f2fe;border:2px solid #7dd3fc;padding:12px;border-radius:8px;margin-bottom:16px;color:#075985">
          ğŸ“ ${data.confirmedAddress || location}
        </div>
        <div id="resultCountBadge" style="background:#d1fae5;border:2px solid #6ee7b7;padding:12px;border-radius:8px;margin-bottom:16px;color:#065f46;font-weight:800">
          âœ“ Showing <span id="resultCount">0</span> Michelin restaurants within 15 miles (sorted by distance)
        </div>
      `;

      sortResults();
      return;
    }

    // NORMAL MODE (search-candidates)
    const step1Response = await fetch('/.netlify/functions/search-candidates', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        location,
        cuisine: cuisine === 'any' ? undefined : cuisine,
        openNow,
        quality: state.qualityFilter
      }),
      signal: searchAbortController.signal
    });

    const step1Data = await step1Response.json();

    if (step1Data?.error) {
      document.getElementById('warnings').innerHTML = `
        <div style="background:#fee2e2;border:2px solid #fca5a5;padding:12px;border-radius:8px;margin-bottom:16px;color:#991b1b;font-weight:800">
          âŒ ${step1Data.error}
        </div>
      `;
      document.getElementById('list').innerHTML =
        `<div style="text-align:center;padding:40px">No results (see error above)</div>`;
      return;
    }

    const eliteRestaurants = Array.isArray(step1Data.elite) ? step1Data.elite : [];
    const moreOptionsRestaurants = Array.isArray(step1Data.moreOptions) ? step1Data.moreOptions : [];

    allRestaurants = [...eliteRestaurants, ...moreOptionsRestaurants].map(c => ({
      ...c,
      walkMinutes: c.walkMinutes ?? c.walkMinEstimate ?? null,
      driveMinutes: c.driveMinutes ?? c.driveMinEstimate ?? null,
      transitMinutes: c.transitMinutes ?? c.transitMinEstimate ?? null
    }));

    // Apply quick filter using estimates
    let timeFiltered = allRestaurants;
    if (state.transport === 'walk' && maxWalkMinutes) timeFiltered = timeFiltered.filter(r => r.walkMinutes && r.walkMinutes <= maxWalkMinutes);
    else if (state.transport === 'drive' && maxDriveMinutes) timeFiltered = timeFiltered.filter(r => r.driveMinutes && r.driveMinutes <= maxDriveMinutes);
    else if (state.transport === 'transit' && maxTransitMinutes) timeFiltered = timeFiltered.filter(r => r.transitMinutes && r.transitMinutes <= maxTransitMinutes);
    allRestaurants = timeFiltered;

    document.getElementById('warnings').innerHTML = `
      <div style="background:#e0f2fe;border:2px solid #7dd3fc;padding:12px;border-radius:8px;margin-bottom:16px;color:#075985">
        ğŸ“ ${step1Data.confirmedAddress || location}
      </div>
      <div style="background:#fef3c7;border:2px solid #fcd34d;padding:12px;border-radius:8px;margin-bottom:16px;color:#92400e;font-weight:700">
        â±ï¸ Showing ${allRestaurants.length} results with estimated times. Getting precise times...
      </div>
    `;

    sortResults();

    // --- Enrich travel times (do NOT discard candidates beyond enrichLimit) ---
    let enrichLimit = 200;
    if (state.transport === 'walk') {
      if (maxWalkMinutes >= 30) enrichLimit = 250;
      else if (maxWalkMinutes >= 20) enrichLimit = 200;
      else enrichLimit = 150;
    } else if (state.transport === 'drive') {
      enrichLimit = 200;
    } else if (state.transport === 'transit') {
      enrichLimit = 200;
    }

    const originalCandidates = [...allRestaurants];
    const toEnrich = originalCandidates.slice(0, enrichLimit);

    const step2Response = await fetch('/.netlify/functions/enrich-times', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        candidates: toEnrich,
        userLocation: step1Data.userLocation,
        transportMode: state.transport,
        targetMinResults: 20,
        cuisineFilter: cuisine === 'any' ? null : cuisine,
        walkTimeLimit: maxWalkMinutes
      }),
      signal: searchAbortController.signal
    });

    if (!step2Response.ok) {
      const errTxt = await step2Response.text();
      throw new Error(`enrich-times failed: ${step2Response.status} ${errTxt}`);
    }

    const step2Data = await step2Response.json();
    const enriched = Array.isArray(step2Data.enrichedCandidates) ? step2Data.enrichedCandidates : [];
    const enrichedById = new Map(enriched.map(r => [r.place_id, r]));

    allRestaurants = originalCandidates.map(r => {
      const e = enrichedById.get(r.place_id);
      if (!e) return r;

      return {
        ...r,
        ...e,
        walkMinutes: e.walkMinutes ?? e.walkMinEstimate ?? r.walkMinutes ?? r.walkMinEstimate ?? null,
        driveMinutes: e.driveMinutes ?? e.driveMinEstimate ?? r.driveMinutes ?? r.driveMinEstimate ?? null,
        transitMinutes: e.transitMinutes ?? e.transitMinEstimate ?? r.transitMinutes ?? r.transitMinEstimate ?? null
      };
    });

    // Apply real-time filter AFTER enrichment
    let realTimeFiltered = allRestaurants;
    if (state.transport === 'walk' && maxWalkMinutes) realTimeFiltered = realTimeFiltered.filter(r => r.walkMinutes != null && r.walkMinutes <= maxWalkMinutes);
    else if (state.transport === 'drive' && maxDriveMinutes) realTimeFiltered = realTimeFiltered.filter(r => r.driveMinutes != null && r.driveMinutes <= maxDriveMinutes);
    else if (state.transport === 'transit' && maxTransitMinutes) realTimeFiltered = realTimeFiltered.filter(r => r.transitMinutes != null && r.transitMinutes <= maxTransitMinutes);
    allRestaurants = realTimeFiltered;

    // âœ… Count badge now uses a live span that displayResults() updates to the rendered list length
    document.getElementById('warnings').innerHTML = `
      <div style="background:#e0f2fe;border:2px solid #7dd3fc;padding:12px;border-radius:8px;margin-bottom:16px;color:#075985">
        ğŸ“ ${step1Data.confirmedAddress || location}
      </div>
      <div id="resultCountBadge" style="background:#d1fae5;border:2px solid #6ee7b7;padding:12px;border-radius:8px;margin-bottom:16px;color:#065f46;font-weight:800">
        âœ“ Showing <span id="resultCount">0</span> restaurants
      </div>
    `;

    sortResults();

  } catch (error) {
    console.error('Search error:', error);
    if (error.name === 'AbortError') return;

    const errorMsg = error.message ? `ğŸ˜” ${error.message}` : 'ğŸ˜” Search failed';

    document.getElementById('warnings').innerHTML = `
      <div style="background:#fee2e2;border:2px solid #fca5a5;padding:12px;border-radius:8px;margin-bottom:16px;color:#991b1b;font-weight:800">
        ${errorMsg}
      </div>
    `;
    document.getElementById('list').innerHTML = `<div style="text-align:center;padding:40px">${errorMsg}</div>`;
  } finally {
    isSearching = false;
    const searchBtn = document.querySelector('.btn');
    searchBtn.disabled = false;
    searchBtn.style.opacity = '1';
    searchBtn.textContent = 'ğŸ” Find Restaurants';
  }
}

function sortResults() {
  let filtered = filterByQuality(allRestaurants);
  const sortBy = document.getElementById('sortBy').value;
  let sorted = [...filtered];

  if (sortBy === 'rating') {
    sorted.sort((a,b)=>(b.googleRating||0)-(a.googleRating||0));
  } else if (sortBy === 'distance') {
    sorted.sort((a,b)=>{
      const aDuration = a.walkDurationSeconds || ((a.walkMinutes||999999) * 60);
      const bDuration = b.walkDurationSeconds || ((b.walkMinutes||999999) * 60);
      if (aDuration !== bDuration) return aDuration - bDuration;
      if ((a.distanceMiles ?? 999999) !== (b.distanceMiles ?? 999999)) return (a.distanceMiles ?? 999999) - (b.distanceMiles ?? 999999);
      if ((b.googleRating||0) !== (a.googleRating||0)) return (b.googleRating||0) - (a.googleRating||0);
      if ((b.googleReviewCount||0) !== (a.googleReviewCount||0)) return (b.googleReviewCount||0) - (a.googleReviewCount||0);
      return String(a.name||'').localeCompare(String(b.name||''));
    });
  } else if (sortBy === 'price') {
    sorted.sort((a,b)=>(a.price_level||0)-(b.price_level||0));
  }

  displayResults(sorted);
}

function displayResults(restaurants) {
  // âœ… This keeps the green banner count matched to what is rendered on screen
  const countEl = document.getElementById('resultCount');
  if (countEl) countEl.textContent = String(restaurants.length);

  if (!restaurants.length) {
    document.getElementById('list').innerHTML =
      '<div style="text-align:center;padding:40px">No restaurants found</div>';
    return;
  }

  const html = restaurants.map(r => {
    let distanceHtml = '';
    if (r.walkMinutes != null) distanceHtml += `<span class="badge distance">ğŸš¶ ${r.walkMinutes} min</span>`;
    if (r.driveMinutes != null) distanceHtml += `<span class="badge distance">ğŸš— ${r.driveMinutes} min</span>`;
    if (r.transitMinutes != null) distanceHtml += `<span class="badge distance">ğŸš‡ ${r.transitMinutes} min</span>`;
    if (r.distanceMiles != null) distanceHtml += `<span class="badge distance">ğŸ“ ${r.distanceMiles} mi</span>`;

    let michelinHtml = '';
    if (r.michelin) {
      const stars = r.michelin.stars || 0;
      if (stars === 3) michelinHtml = `<span class="badge" style="background:#ff4444;color:white;border-color:#ff4444">â­â­â­ Michelin Three Stars</span>`;
      else if (stars === 2) michelinHtml = `<span class="badge" style="background:#ff4444;color:white;border-color:#ff4444">â­â­ Michelin Two Stars</span>`;
      else if (stars === 1) michelinHtml = `<span class="badge" style="background:#ff4444;color:white;border-color:#ff4444">â­ Michelin One Star</span>`;
      else michelinHtml = `<span class="badge" style="background:#ff4444;color:white;border-color:#ff4444">Michelin</span>`;
    }

    const rating = (r.googleRating || 0);
    const reviews = (r.googleReviewCount || 0);

    const ratingHtml = (r.googleRating != null && r.googleRating !== 0)
      ? `<span class="badge">â­ ${Number(rating).toFixed(1)} (${reviews})</span>` 
      : `<span class="badge" style="color:#666">â­ Google rating N/A</span>`;

    const priceHtml = r.price_level ? `<span class="badge">ğŸ’° ${'$'.repeat(r.price_level)}</span>` : `<span class="badge">ğŸ’° N/A</span>`;

    const mapsUrl = r.place_id
      ? `https://www.google.com/maps/search/?api=1&query_place_id=${r.place_id}` 
      : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((r.name || '') + ' ' + (r.formatted_address || 'New York, NY'))}`;

    return `
      <div class="restaurant">
        <h3>${r.name || 'Unknown'}</h3>
        <div class="cuisine">${r.vicinity || r.formatted_address || ''}</div>
        <div class="badges">
          ${michelinHtml}
          ${ratingHtml}
          ${priceHtml}
          ${r.opening_hours?.open_now ? '<span class="badge">âœ… Open</span>' : ''}
          ${distanceHtml}
          <button onclick="window.open('${mapsUrl}','_blank')"
            style="margin-left:auto;padding:8px 16px;background:#4285f4;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:14px">
            ğŸ“ Maps
          </button>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('list').innerHTML = html;
}

function back() {
  document.getElementById('search').classList.remove('hidden');
  document.getElementById('results').classList.add('hidden');
}
</script>
</body>
</html>
